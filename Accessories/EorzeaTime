<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>エオルゼア時間・天候シード計算機</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font setting -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0f172a; /* Slate-900 */
            color: #e2e8f0; /* Slate-200 */
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b;
        }
        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 4px;
        }
        .modal {
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }
        .moon-phase {
            display: inline-block;
            width: 1.25rem;
            height: 1.25rem;
            line-height: 1.25rem;
            text-align: center;
            border-radius: 50%;
            background-color: #334155;
            color: #fcd34d;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-10">
            <h1 class="text-3xl font-bold text-sky-400">FF14 エオルゼア計算機</h1>
            <p class="text-sm text-slate-400 mt-1">現実時刻 (JST) に基づくET、シード、月齢の計算</p>
        </header>

        <!-- 入力フォーム -->
        <div class="bg-slate-800 p-6 rounded-xl shadow-lg mb-8">
            <label for="input-datetime" class="block text-sm font-medium mb-2 text-slate-300">
                現実時刻を入力 (JST)
            </label>
            <input type="datetime-local" id="input-datetime" class="w-full p-3 rounded-lg bg-slate-700 text-slate-100 border border-slate-600 focus:ring-sky-500 focus:border-sky-500" />
            
            <!-- エリア選択関連のUIを削除しました -->

            <div class="mt-4 flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-4">
                <button onclick="calculate()" class="w-full sm:w-1/2 bg-sky-600 hover:bg-sky-700 text-white font-semibold py-2 rounded-lg transition duration-150">
                    計算する
                </button>
                <button onclick="setCurrentTime()" class="w-full sm:w-1/2 bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2 rounded-lg transition duration-150">
                    現在時刻を設定
                </button>
            </div>
        </div>

        <!-- 結果表示エリア -->
        <div id="results" class="space-y-6">

            <!-- エオルゼア時間・月齢カード -->
            <div class="bg-slate-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-xl font-semibold mb-4 text-sky-400 border-b border-slate-700 pb-2">基本情報</h2>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    
                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-xs text-slate-400">エオルゼア時間 (ET)</p>
                        <p id="et-time" class="text-2xl font-bold text-white">--:--</p>
                    </div>

                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-xs text-slate-400">天候シード (0-99)</p>
                        <p id="weather-seed" class="text-2xl font-bold text-yellow-400">--</p>
                    </div>
                    
                    <div class="p-3 bg-slate-700 rounded-lg">
                        <p class="text-xs text-slate-400">月齢 (Moon Phase)</p>
                        <p id="moon-phase" class="text-2xl font-bold text-white">--</p>
                    </div>

                    <!-- 予想天候の表示エリアを削除しました -->
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- 2. 天候・時刻計算関数 ---

        const OFFSET_MS = 32400 * 1000;
        const OFFSET_SECONDS = 32400;

        /**
         * 現在の時刻をローカルタイムのISO文字列 (YYYY-MM-DDTHH:MM) に変換し、inputに設定
         */
        function toLocalIsoString(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        /**
         * 現在時刻を入力フィールドに設定し、秒も考慮して計算する
         */
        function setCurrentTime() {
            const now = new Date();
            document.getElementById('input-datetime').value = toLocalIsoString(now);
            calculate(now); 
        }

        /**
         * エオルゼア時間 (Eorzea Time) を計算
         */
        function getEorzeaTime(date) {
            let unixMs = date.getTime();
            const REAL_MS_PER_ET_HOUR = 175 * 1000;
            const ET_HOURS_PER_DAY = 24;
            const eorzeaTotalHours = Math.floor(unixMs / REAL_MS_PER_ET_HOUR);
            const hours = eorzeaTotalHours % ET_HOURS_PER_DAY;
            const remainingMs = unixMs % REAL_MS_PER_ET_HOUR;
            const REAL_MS_PER_ET_MINUTE = REAL_MS_PER_ET_HOUR / 60; 
            const minutes = Math.floor(remainingMs / REAL_MS_PER_ET_MINUTE);

            return { 
                hours: hours.toString().padStart(2, "0"), 
                minutes: minutes.toString().padStart(2, "0") 
            };
        }

        /**
         * 月齢 (Moon Phase) を計算
         */
        function getEorzeaMoonPhase(date) {
            let unixSeconds = Math.floor(date.getTime() / 1000);
            const EORZEA_SPEED_RATIO = 20.57142857142857;
            const eorzeaDays = Math.floor(unixSeconds * EORZEA_SPEED_RATIO / 86400);
            const phase = (eorzeaDays % 32) + 1;
            return phase;
        }

        /**
         * 天候シード計算 (元のシンプルなロジック)
         */
        function getEorzeaWeatherSeed(date = new Date()) {
            // リアルタイムのUNIX秒を取得
            const unixSeconds = Math.floor(date.getTime() / 1000);

            // 1 bell = 175秒
            const eorzeanHours = Math.floor(unixSeconds / 175);
            const eorzeanDays = Math.floor(eorzeanHours / 24);

            // 天候決定枠 (0, 8, 16 のいずれか)
            let timeChunk = (eorzeanHours % 24) - (eorzeanHours % 8);
            timeChunk = (timeChunk + 8) % 24;

            // シード値の基点: (経過日数 * 100) + チャンク時間
            const seed = eorzeanDays * 100 + timeChunk;

            // 擬似乱数生成
            const step1 = (seed << 11) ^ seed;
            const step2 = ((step1 >>> 8) ^ step1) >>> 0; 

            return step2 % 100; // 0〜99
        }

        // --- 3. メイン計算と表示ロジック ---

        /**
         * 入力値を取得し、計算を実行し、結果を表示する
         */
        function calculate(initialDate) {
            let localDate;
            const inputElement = document.getElementById('input-datetime');
            const inputTime = inputElement.value;
            
            if (!inputTime) {
                alertBox('時刻を入力してください。');
                return;
            }

            if (initialDate instanceof Date) {
                localDate = initialDate;
            } else {
                localDate = new Date(inputTime); 
            }
            
            if (isNaN(localDate.getTime())) {
                alertBox('無効な日付形式です。');
                return;
            }

            // 計算実行
            const et = getEorzeaTime(localDate);
            const seed = getEorzeaWeatherSeed(localDate);
            const moon = getEorzeaMoonPhase(localDate);

            // 結果の表示
            document.getElementById('et-time').textContent = `${et.hours}:${et.minutes}`;
            document.getElementById('moon-phase').innerHTML = `${moon} <span class="text-base text-slate-400">/ 32</span>`;
            document.getElementById('weather-seed').textContent = seed.toString();
        }
        
        /**
         * カスタムアラートボックス
         */
        function alertBox(message) {
            const modalId = 'custom-alert-modal';
            let modal = document.getElementById(modalId);
            if (!modal) {
                modal = document.createElement('div');
                modal.id = modalId;
                modal.className = 'modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 transition-opacity duration-300';
                modal.style.opacity = '0';
                modal.innerHTML = `
                    <div class="bg-slate-700 p-6 rounded-lg max-w-sm w-full shadow-2xl transform scale-95 transition-transform duration-300">
                        <h3 class="text-xl font-bold text-red-400 mb-3">注意</h3>
                        <p id="alert-message" class="text-slate-200 mb-4"></p>
                        <button onclick="closeAlertBox('${modalId}')" class="w-full bg-red-600 hover:bg-red-700 text-white font-semibold py-2 rounded-lg transition duration-150">
                            閉じる
                        </button>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            document.getElementById('alert-message').textContent = message;
            
            setTimeout(() => {
                modal.style.opacity = '1';
                modal.querySelector('div').style.transform = 'scale(1)';
            }, 10);
        }

        function closeAlertBox(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.style.opacity = '0';
                modal.querySelector('div').style.transform = 'scale(0.95)';
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }
        
        // 初期化処理
        window.onload = function() {
            setCurrentTime();
        }

    </script>
</body>
</html>
